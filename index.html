<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Music Notation</title>
    <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.7.6/build/opensheetmusicdisplay.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #ccc;
        }

        textarea {
            width: 400px;
            height: 150px;
            font-family: monospace;
        }

        #render {
            margin-top: 20px;
            padding: 10px;
            background-color: white;
        }
    </style>
</head>

<body>
    <h1>Music Notation</h1>

    <label>Score Title:
        <input id="title" type="text" value="My Score">
    </label>
    <br>
    <label>Part Name:
        <input id="partName" type="text" value="Music">
    </label>
    <br>
    <label>Clef:
        <select id="clef">
            <option value="G" selected>Treble (G)</option>
            <option value="F">Bass (F)</option>
        </select>
    </label>
    <br>
    <label>Key signature (+ sharps / - flats):
        <input id="key" type="number" value="0" min="-7" max="7">
    </label>
    <br>
    <label>Time signature:
        <input id="beats" type="number" value="4" min="1"> /
        <input id="beatType" type="number" value="4" min="1">
    </label>

    <p>Enter notes:</p>
    <textarea id="input">1.5 C4
0.5 G#4
2 Eb5
1 rest</textarea><br>
    <button onclick="compile()">Compile & Render</button>
    <button onclick="">Export to PDF</button>

    <div id="render"></div>

    <script>
        const osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("render");

        function compile() {
            const input = document.getElementById("input").value.trim().split("\n");

            const title = document.getElementById("title").value;
            const partName = document.getElementById("partName").value;
            const clef = document.getElementById("clef").value;
            const key = parseInt(document.getElementById("key").value);
            const beats = parseInt(document.getElementById("beats").value);
            const beatType = parseInt(document.getElementById("beatType").value);

            const divisionsPerBeat = 2; // can adjust
            const totalDivisionsPerMeasure = beats * divisionsPerBeat;

            let measureFilled = 0;
            let measureNumber = 1;

            let musicxml = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE score-partwise PUBLIC
    "-//Recordare//DTD MusicXML 3.1 Partwise//EN"
    "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <work>
    <work-title>${title}</work-title>
  </work>
  <part-list>
    <score-part id="P1">
      <part-name>${partName}</part-name>
    </score-part>
  </part-list>
  <part id="P1">
    <measure number="1">
      <attributes>
        <divisions>${divisionsPerBeat}</divisions>
        <key><fifths>${key}</fifths></key>
        <time><beats>${beats}</beats><beat-type>${beatType}</beat-type></time>
        <clef><sign>${clef}</sign><line>${clef === "F" ? 4 : 2}</line></clef>
      </attributes>
`;

            input.forEach(line => {
                const [durStr, note] = line.split(/\s+/);
                if (!durStr || !note) return;

                const rawDur = parseFloat(durStr);
                const dotted = durStr.includes(".5");
                const durationVal = rawDur * divisionsPerBeat;

                let isRest = note.toLowerCase() === "rest";

                let remainingDuration = durationVal;

                while (remainingDuration > 0) {
                    const spaceLeft = totalDivisionsPerMeasure - measureFilled;
                    const durInThisMeasure = Math.min(remainingDuration, spaceLeft);

                    const isTiedStart = remainingDuration > durInThisMeasure;
                    const isTiedStop = measureFilled === 0 && remainingDuration < totalDivisionsPerMeasure; // start of new measure continuation

                    if (isRest) {
                        musicxml += `
        <note>
          <rest/>
          <duration>${durInThisMeasure}</duration>
          ${dotted ? "<dot/>" : ""}
        </note>`;
                    } else {
                        const match = note.match(/^([A-Ga-g])([#b]*)(\d)$/);
                        if (!match) return;

                        let step = match[1].toUpperCase();
                        let accidentals = match[2];
                        let octave = match[3];

                        let alter = "";
                        if (accidentals.includes("#")) alter = `<alter>${accidentals.length}</alter>`;
                        if (accidentals.includes("b")) alter = `<alter>-${accidentals.length}</alter>`;

                        musicxml += `
        <note>
          <pitch>
            <step>${step}</step>
            ${alter}
            <octave>${octave}</octave>
          </pitch>
          <duration>${durInThisMeasure}</duration>
          ${dotted ? "<dot/>" : ""}
          ${isTiedStart ? '<tie type="start"/>' : ""}
          ${isTiedStop ? '<tie type="stop"/>' : ""}
          <notations>
            ${isTiedStart ? '<tied type="start"/>' : ""}
            ${isTiedStop ? '<tied type="stop"/>' : ""}
          </notations>
        </note>`;
                    }

                    remainingDuration -= durInThisMeasure;
                    measureFilled += durInThisMeasure;

                    if (measureFilled >= totalDivisionsPerMeasure) {
                        musicxml += "\n</measure>\n<measure>\n";
                        measureFilled = 0;
                    }
                }
            });

            musicxml += `
    </measure>
  </part>
</score-partwise>`;

            osmd.load(musicxml).then(() => osmd.render());
        }

        compile();
    </script>
</body>

</html>
